version: "3.9"

# ============================================================
# Global build defaults (avoid repeating context/dockerfile)
# ============================================================
x-build-defaults: &build_defaults
  context: .
  dockerfile: Dockerfile


services:
  # ============================================================
  #  Core Model Training / Prediction Service
  # ============================================================
  stock-predictor:
    build:
      <<: *build_defaults
      target: stock-predictor
    container_name: stock-predictor
    environment:
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - DATA_ROOT=/data
      - MODEL_DIR=/models
      - OUTPUT_DIR=/output
      - LOG_DIR=/logs
    volumes:
      - ./:/app
      - ./data:/data
      - ./models:/models
      - ./output:/output
      - ./logs:/logs
    working_dir: /app
    tty: true
    command: [ "bash", "-lc", "python3.11 -m src.prediction.predict; tail -f /dev/null" ]

    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]

  # ============================================================
  #  FastAPI Backend (Uvicorn)
  # ============================================================
  api:
    build:
      <<: *build_defaults
      target: api
    container_name: stock-predictor-api
    ports:
      - "8000:8000"
    environment:
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - DATA_ROOT=/data
      - MODEL_DIR=/models
      - OUTPUT_DIR=/output
      - LOG_DIR=/logs
      - LANG=C.UTF-8
      - LC_ALL=C.UTF-8
    volumes:
      - ./:/app
      - ./data:/data
      - ./models:/models
      - ./output:/output
      - ./logs:/logs
    working_dir: /app
    tty: true
    command: [
      "python3.11", "-m", "uvicorn", "src.api.app:app",
      "--host", "0.0.0.0", "--port", "8000",
      "--workers", "1"
    ]
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]

  # ============================================================
  #  Streamlit Frontend
  # ============================================================
  ui:
    build:
      <<: *build_defaults
      target: ui
    container_name: stock-predictor-ui
    depends_on:
      - api
    ports:
      - "8501:8501"
    environment:
      - API_BASE=http://api:8000
      - PUBLIC_API_BASE=http://localhost:8000
      - LANG=C.UTF-8
      - LC_ALL=C.UTF-8
    volumes:
      - ./:/app
      - ./data:/data
      - ./models:/models
      - ./output:/output
      - ./logs:/logs
    working_dir: /app
    tty: true
    command: [
      "streamlit", "run", "src/ui/app.py",
      "--server.address=0.0.0.0",
      "--server.port=8501"
    ]
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
